<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>FeedbackAnalysisService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">test</a> &gt; <a href="index.source.html" class="el_package">com.talentradar.assessment_service.service.impl</a> &gt; <span class="el_source">FeedbackAnalysisService.java</span></div><h1>FeedbackAnalysisService.java</h1><pre class="source lang-java linenums">package com.talentradar.assessment_service.service.impl;

import com.talentradar.assessment_service.dto.analysis.FeedbackAnalysisDto;
import com.talentradar.assessment_service.dto.feedbackComment.response.FeedbackCommentDto;
import com.talentradar.assessment_service.dto.feedbackDimension.response.FeedbackDimensionDto;
import com.talentradar.assessment_service.model.Assessment;
import com.talentradar.assessment_service.model.AssessmentDimension;
import com.talentradar.assessment_service.model.Feedback;
import com.talentradar.assessment_service.model.SubmissionStatus;
import com.talentradar.assessment_service.repository.AssessmentRepository;
import com.talentradar.assessment_service.service.FeedbackCommentService;
import com.talentradar.assessment_service.service.FeedbackDimensionService;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.UUID;
import java.util.stream.Collectors;

@Service
@RequiredArgsConstructor
@Transactional(readOnly = true)
<span class="fc" id="L27">@Slf4j</span>
public class FeedbackAnalysisService {
    
    private final AssessmentRepository assessmentRepository;
    private final FeedbackDimensionService feedbackDimensionService;
    private final FeedbackCommentService feedbackCommentService;
    
    /**
     * Creates a combined analysis DTO with user's self-assessment and manager feedback
     * @param feedback The submitted feedback
     * @return FeedbackAnalysisDto with combined data
     */
    public FeedbackAnalysisDto createAnalysisDto(Feedback feedback) {
<span class="fc" id="L40">        log.info(&quot;Creating analysis DTO for feedback: {} (Manager: {}, Developer: {})&quot;, </span>
<span class="fc" id="L41">                feedback.getId(), feedback.getManagerId(), feedback.getDeveloperId());</span>
        
        // Get the latest submitted assessment for the developer
<span class="fc" id="L44">        Assessment latestAssessment = getLatestSubmittedAssessment(feedback.getDeveloperId());</span>
<span class="pc bpc" id="L45" title="1 of 2 branches missed.">        if (latestAssessment == null) {</span>
<span class="nc" id="L46">            log.warn(&quot;No submitted assessment found for developer: {}&quot;, feedback.getDeveloperId());</span>
<span class="nc" id="L47">            return createFeedbackOnlyAnalysis(feedback);</span>
        }
        
<span class="fc" id="L50">        FeedbackAnalysisDto.SelfAssessmentData selfAssessment = buildSelfAssessmentData(latestAssessment);</span>
        
<span class="fc" id="L52">        FeedbackAnalysisDto.ManagerFeedbackData managerFeedback = buildManagerFeedbackData(feedback);</span>
        
<span class="fc" id="L54">        FeedbackAnalysisDto analysisDto = FeedbackAnalysisDto.builder()</span>
<span class="fc" id="L55">                .userId(feedback.getDeveloperId().toString())</span>
<span class="fc" id="L56">                .selfAssessment(selfAssessment)</span>
<span class="fc" id="L57">                .managerFeedback(managerFeedback)</span>
<span class="fc" id="L58">                .build();</span>
        
<span class="fc" id="L60">        log.info(&quot;Successfully created analysis DTO for user: {}&quot;, feedback.getDeveloperId());</span>
<span class="fc" id="L61">        return analysisDto;</span>
    }
    
    private Assessment getLatestSubmittedAssessment(UUID developerId) {
<span class="fc" id="L65">        return assessmentRepository.findLatestSubmittedAssessmentByUserId(developerId)</span>
<span class="fc" id="L66">                .orElse(null);</span>
    }
    
    private FeedbackAnalysisDto.SelfAssessmentData buildSelfAssessmentData(Assessment assessment) {
<span class="fc" id="L70">        Map&lt;String, Integer&gt; scores = new HashMap&lt;&gt;();</span>
        
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (assessment.getDimensions() != null) {</span>
<span class="fc bfc" id="L73" title="All 2 branches covered.">            for (AssessmentDimension dimension : assessment.getDimensions()) {</span>
<span class="fc" id="L74">                String dimensionName = dimension.getDimensionDefinition().getDimensionName()</span>
<span class="fc" id="L75">                        .toLowerCase()</span>
<span class="fc" id="L76">                        .replaceAll(&quot;\\s+&quot;, &quot;&quot;)</span>
<span class="fc" id="L77">                        .replaceAll(&quot;&amp;&quot;, &quot;&quot;);</span>
<span class="fc" id="L78">                scores.put(dimensionName, dimension.getRating());</span>
<span class="fc" id="L79">            }</span>
        }
        
<span class="fc" id="L82">        return FeedbackAnalysisDto.SelfAssessmentData.builder()</span>
<span class="fc" id="L83">                .scores(scores)</span>
<span class="fc" id="L84">                .reflection(assessment.getReflection())</span>
<span class="fc" id="L85">                .build();</span>
    }
    
    private FeedbackAnalysisDto.ManagerFeedbackData buildManagerFeedbackData(Feedback feedback) {

<span class="fc" id="L90">        List&lt;FeedbackDimensionDto&gt; dimensions = feedbackDimensionService</span>
<span class="fc" id="L91">                .getFeedbackDimensionsByFeedbackId(feedback.getId());</span>
        
<span class="fc" id="L93">        Map&lt;String, Integer&gt; scores = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        for (FeedbackDimensionDto dimension : dimensions) {</span>
<span class="fc" id="L95">            String dimensionName = dimension.getDimensionDefinition().getDimensionName()</span>
<span class="fc" id="L96">                    .toLowerCase()</span>
<span class="fc" id="L97">                    .replaceAll(&quot;\\s+&quot;, &quot;&quot;)</span>
<span class="fc" id="L98">                    .replaceAll(&quot;&amp;&quot;, &quot;&quot;);</span>
<span class="fc" id="L99">            scores.put(dimensionName, dimension.getRating());</span>
<span class="fc" id="L100">        }</span>
        
        // Get feedback comments and combine them
<span class="fc" id="L103">        List&lt;FeedbackCommentDto&gt; comments = feedbackCommentService</span>
<span class="fc" id="L104">                .getFeedbackCommentsByFeedbackId(feedback.getId());</span>
        
<span class="fc" id="L106">        String combinedReflection = comments.stream()</span>
<span class="fc" id="L107">                .map(comment -&gt; comment.getComment().getCommentTitle() + &quot;: &quot; + comment.getFeedbackCommentBody())</span>
<span class="fc" id="L108">                .collect(Collectors.joining(&quot; | &quot;));</span>
        
<span class="fc" id="L110">        return FeedbackAnalysisDto.ManagerFeedbackData.builder()</span>
<span class="fc" id="L111">                .scores(scores)</span>
<span class="fc" id="L112">                .reflection(combinedReflection)</span>
<span class="fc" id="L113">                .build();</span>
    }
    
    private FeedbackAnalysisDto createFeedbackOnlyAnalysis(Feedback feedback) {
        // Create analysis with only manager feedback data
<span class="nc" id="L118">        FeedbackAnalysisDto.ManagerFeedbackData managerFeedback = buildManagerFeedbackData(feedback);</span>
        
<span class="nc" id="L120">        return FeedbackAnalysisDto.builder()</span>
<span class="nc" id="L121">                .userId(feedback.getDeveloperId().toString())</span>
<span class="nc" id="L122">                .selfAssessment(null) // No self-assessment available</span>
<span class="nc" id="L123">                .managerFeedback(managerFeedback)</span>
<span class="nc" id="L124">                .build();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>